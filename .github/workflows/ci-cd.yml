name: Portfolio CI/CD - Final Working Version

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  quality-checks:
    name: Quality & Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v3
    
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    # ============================================
    # STEP 1: CHECK FILES EXIST
    # ============================================
    - name: ğŸ“ Check Required Files
      run: |
        echo "=== Checking Files ==="
        
        files=("index.html" "styles.css" "script.js")
        missing=0
        
        for file in "${files[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… $file exists"
          else
            echo "âŒ $file MISSING!"
            missing=1
          fi
        done
        
        if [ $missing -eq 1 ]; then
          exit 1
        fi
        echo "âœ… All required files present"
    
    # ============================================
    # STEP 2: VALIDATE HTML - CATCHES MISSING TAGS
    # ============================================
    - name: ğŸ” Validate HTML Structure
      run: |
        echo "=== Validating HTML ==="
        
        # Install the BEST HTML validator
        npm install --save-dev html-validate
        
        # Create strict config
        cat > .htmlvalidate.json << 'EOF'
        {
          "extends": ["html-validate:recommended"],
          "rules": {
            "void-style": "off",
            "no-trailing-whitespace": "off",
            "no-inline-style": "off",
            "require-sri": "off",
            "no-implicit-close": "error",
            "element-required-attributes": "error",
            "element-permitted-content": "error",
            "close-order": "error",
            "no-missing-references": "error"
          }
        }
        EOF
        
        echo "Running HTML validation..."
        if npx html-validate index.html 2>&1 | tee html-errors.log; then
          echo ""
          echo "âœ… HTML validation passed"
        else
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘   âŒ HTML VALIDATION FAILED!          â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Errors found:"
          cat html-errors.log
          echo ""
          echo "ğŸ”§ Common fixes:"
          echo "  1. Check for missing closing tags"
          echo "  2. Verify all <tag> have </tag>"
          echo "  3. Check proper nesting"
          echo "  4. Look at line numbers above"
          exit 1
        fi
        
        # Double-check tag balance (backup validation)
        echo ""
        echo "Double-checking tag balance..."
        
        # Comprehensive list of HTML tags to check
        tags=("div" "section" "article" "header" "footer" "nav" "main" "body" "head" "html" "form" "ul" "ol" "li" "table" "tr" "td" "th" "tbody" "thead" "h1" "h2" "h3" "h4" "h5" "h6" "p" "a" "span" "button")
        errors=0
        
        for tag in "${tags[@]}"; do
          # Count opening tags (exclude self-closing and closing tags)
          open=$(grep -o -E "<$tag([[:space:]>])[^>]*>" index.html | grep -v "</$tag>" | wc -l)
          # Count closing tags
          close=$(grep -o "</$tag>" index.html | wc -l)
          
          if [ $open -ne $close ]; then
            echo "âŒ ERROR: <$tag> unbalanced (open: $open, close: $close)"
            errors=1
          else
            if [ $open -gt 0 ]; then
              echo "âœ… <$tag> balanced ($open pairs)"
            fi
          fi
        done
        
        if [ $errors -eq 1 ]; then
          echo ""
          echo "âŒ FOUND UNBALANCED TAGS!"
          echo "Fix these before deploying!"
          exit 1
        fi
        
        echo ""
        echo "âœ… HTML validation complete - ALL TAGS BALANCED"
    
    # ============================================
    # STEP 3: VALIDATE CSS
    # ============================================
    - name: ğŸ¨ Validate CSS Syntax
      run: |
        echo "=== Validating CSS ==="
        
        # Install modern CSS validator
        npm install --save-dev stylelint stylelint-config-standard
        
        # Create config
        cat > .stylelintrc.json << 'EOF'
        {
          "extends": "stylelint-config-standard",
          "rules": {
            "property-no-vendor-prefix": null,
            "no-descending-specificity": null,
            "selector-class-pattern": null,
            "custom-property-pattern": null,
            "alpha-value-notation": "number"
          }
        }
        EOF
        
        echo "Running CSS validation..."
        if npx stylelint styles.css 2>&1 | tee css-errors.log; then
          echo "âœ… CSS validation passed"
        else
          echo "âš ï¸ CSS has warnings (not blocking deployment)"
          cat css-errors.log
        fi
        
        # Check brace balance
        echo ""
        echo "Checking CSS structure..."
        open=$(grep -o "{" styles.css | wc -l)
        close=$(grep -o "}" styles.css | wc -l)
        
        if [ $open -ne $close ]; then
          echo "âŒ ERROR: CSS braces unbalanced!"
          echo "   Opening braces: $open"
          echo "   Closing braces: $close"
          exit 1
        fi
        
        echo "âœ… CSS braces balanced ($open pairs)"
        
        # File size check
        size=$(wc -c < styles.css)
        kb=$((size / 1024))
        echo "ğŸ“ CSS file size: ${kb} KB"
        
        if [ $size -gt 512000 ]; then
          echo "âŒ ERROR: CSS exceeds 500 KB!"
          exit 1
        fi
        
        echo "âœ… CSS validation complete"
    
    # ============================================
    # STEP 4: VALIDATE JAVASCRIPT
    # ============================================
    - name: âš™ï¸ Validate JavaScript Syntax
      run: |
        echo "=== Validating JavaScript ==="
        
        # Use Node.js to check syntax (most reliable)
        echo "Checking JavaScript syntax..."
        if node --check script.js 2>&1 | tee js-errors.log; then
          echo "âœ… JavaScript syntax is valid"
        else
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘   âŒ JAVASCRIPT SYNTAX ERROR!         â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          cat js-errors.log
          echo ""
          echo "ğŸ”§ Common fixes:"
          echo "  1. Check for missing brackets/braces"
          echo "  2. Check for unclosed strings"
          echo "  3. Look for missing semicolons"
          echo "  4. Verify function syntax"
          exit 1
        fi
        
        # Check for dangerous code
        echo ""
        echo "Security checks..."
        
        if grep -q "eval(" script.js; then
          echo "âŒ ERROR: Found eval() - SECURITY RISK!"
          exit 1
        fi
        echo "âœ… No eval() found"
        
        # File size
        size=$(wc -c < script.js)
        kb=$((size / 1024))
        echo "ğŸ“ JavaScript size: ${kb} KB"
        
        if [ $size -gt 1048576 ]; then
          echo "âŒ ERROR: JavaScript exceeds 1 MB!"
          exit 1
        fi
        
        echo "âœ… JavaScript validation complete"
    
    # ============================================
    # STEP 5: SECURITY SCAN
    # ============================================
    - name: ğŸ”’ Security Scan
      run: |
        echo "=== Security Scan ==="
        
        errors=0
        
        # Check for localhost in actual code (not comments)
        echo "Checking for localhost URLs..."
        if grep -E "(href|src|fetch|axios|ajax).*localhost" script.js index.html 2>/dev/null; then
          echo "âŒ ERROR: Found localhost URL in code!"
          errors=1
        else
          echo "âœ… No localhost URLs"
        fi
        
        # Check for API keys (actual keys, not the word)
        echo ""
        echo "Checking for API keys..."
        if grep -E "(api[_-]?key|apikey).*=.*['\"][a-zA-Z0-9]{20,}" script.js 2>/dev/null; then
          echo "âŒ ERROR: Found API key!"
          errors=1
        else
          echo "âœ… No API keys"
        fi
        
        # Check for hardcoded passwords
        echo ""
        echo "Checking for passwords..."
        if grep -E "(password|passwd).*=.*['\"][^'\"]{5,}['\"]" script.js | grep -v "placeholder" | grep -v "type=" 2>/dev/null; then
          echo "âŒ ERROR: Found hardcoded password!"
          errors=1
        else
          echo "âœ… No hardcoded passwords"
        fi
        
        if [ $errors -eq 1 ]; then
          echo ""
          echo "âŒ SECURITY ISSUES FOUND!"
          exit 1
        fi
        
        echo ""
        echo "âœ… Security scan passed"
    
    # ============================================
    # STEP 6: PERFORMANCE CHECK
    # ============================================
    - name: ğŸ“Š Performance Check
      run: |
        echo "=== Performance Analysis ==="
        
        html_size=$(wc -c < index.html)
        css_size=$(wc -c < styles.css)
        js_size=$(wc -c < script.js)
        total=$((html_size + css_size + js_size))
        
        echo "ğŸ“¦ File Sizes:"
        printf "   HTML: %6d KB\n" $((html_size / 1024))
        printf "   CSS:  %6d KB\n" $((css_size / 1024))
        printf "   JS:   %6d KB\n" $((js_size / 1024))
        printf "   TOTAL: %5d KB\n" $((total / 1024))
        
        if [ $total -gt 2097152 ]; then
          echo "âš ï¸ Warning: Total size exceeds 2 MB"
        else
          echo "âœ… Total size is good"
        fi
        
        echo ""
        echo "ğŸ“ Lines of Code:"
        printf "   HTML: %6d lines\n" $(wc -l < index.html)
        printf "   CSS:  %6d lines\n" $(wc -l < styles.css)
        printf "   JS:   %6d lines\n" $(wc -l < script.js)
        
        echo ""
        echo "âœ… Performance check complete"
    
    # ============================================
    # FINAL SUMMARY
    # ============================================
    - name: âœ… All Checks Passed
      run: |
        echo ""
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘                                           â•‘"
        echo "â•‘   âœ… ALL QUALITY CHECKS PASSED! ğŸ‰       â•‘"
        echo "â•‘                                           â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "âœ… Files validated"
        echo "âœ… HTML structure correct (all tags balanced)"
        echo "âœ… CSS syntax valid"
        echo "âœ… JavaScript syntax valid"
        echo "âœ… Security scan passed"
        echo "âœ… Performance acceptable"
        echo ""
        echo "ğŸš€ Your code is production-ready!"
        echo ""
        echo "ğŸ“‹ Build Info:"
        echo "   Commit: ${{ github.sha }}"
        echo "   Author: ${{ github.actor }}"
        echo "   Branch: ${{ github.ref_name }}"
  
  deployment-ready:
    name: Deployment Ready
    runs-on: ubuntu-latest
    needs: quality-checks
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
    - name: ğŸ‰ Ready to Deploy
      run: |
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘                                           â•‘"
        echo "â•‘       ğŸ‰ DEPLOYMENT READY! ğŸš€            â•‘"
        echo "â•‘                                           â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "âœ… All quality gates passed"
        echo "âœ… Code is production-ready"
        echo ""
        echo "ğŸŒ Vercel will deploy automatically"
        echo "â±ï¸  ETA: 1-2 minutes"
    
    - name: ğŸ“ Deployment Summary
      run: |
        echo "### ğŸ‰ Deployment Ready! ğŸš€" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "All quality checks passed successfully!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Validations:**" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Files validated" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… HTML structure (all tags balanced)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… CSS syntax" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… JavaScript syntax" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Security scan" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Performance check" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Build:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Author:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY