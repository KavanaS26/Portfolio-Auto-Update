name: Portfolio CI/CD - Robust Validation

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  quality-checks:
    name: Quality Checks
    runs-on: ubuntu-latest
    
    steps:
    # Step 1: Get code
    - name: üì• Checkout Code
      uses: actions/checkout@v3
    
    # Step 2: Setup Node.js
    - name: üü¢ Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    # Step 3: Check files exist
    - name: üìÅ Check Required Files
      run: |
        echo "=== Checking Required Files ==="
        EXIT_CODE=0
        
        if [ -f "index.html" ]; then
          echo "‚úÖ index.html exists"
        else
          echo "‚ùå index.html NOT FOUND"
          EXIT_CODE=1
        fi
        
        if [ -f "styles.css" ]; then
          echo "‚úÖ styles.css exists"
        else
          echo "‚ùå styles.css NOT FOUND"
          EXIT_CODE=1
        fi
        
        if [ -f "script.js" ]; then
          echo "‚úÖ script.js exists"
        else
          echo "‚ùå script.js NOT FOUND"
          EXIT_CODE=1
        fi
        
        if [ $EXIT_CODE -ne 0 ]; then
          echo ""
          echo "‚ùå ERROR: Required files are missing!"
          exit 1
        fi
        
        echo "‚úÖ All required files present"
    
    # Step 4: Validate HTML Structure
    - name: üîç Validate HTML Structure
      run: |
        echo "=== Validating HTML Structure ==="
        
        # Install HTML validator (using html-validate which is reliable)
        npm install html-validate
        
        # Create minimal config
        cat > .htmlvalidate.json << 'EOF'
        {
          "extends": ["html-validate:recommended"],
          "rules": {
            "no-trailing-whitespace": "off",
            "void-style": "off",
            "no-inline-style": "off"
          }
        }
        EOF
        
        # Run validation
        echo "Running HTML validation..."
        if npx htmlvalidate index.html 2>&1 | tee validation.log; then
          echo "‚úÖ HTML structure validation passed"
        else
          echo ""
          echo "‚ùå HTML VALIDATION FAILED!"
          echo ""
          echo "Errors found:"
          cat validation.log
          echo ""
          echo "Common issues to check:"
          echo "  1. All opening tags have closing tags"
          echo "  2. Tags are properly nested"
          echo "  3. No typos in tag names"
          echo "  4. Attributes have proper quotes"
          exit 1
        fi
        
        # Additional checks - Check tag balance
        echo ""
        echo "Checking tag balance..."
        EXIT_CODE=0
        
        for tag in div section article header footer nav main body head html; do
          OPEN=$(grep -o "<$tag" index.html | grep -v "</$tag" | wc -l)
          CLOSE=$(grep -o "</$tag>" index.html | wc -l)
          
          if [ $OPEN -ne $CLOSE ]; then
            echo "‚ùå ERROR: Unbalanced <$tag> tags (opening: $OPEN, closing: $CLOSE)"
            EXIT_CODE=1
          else
            echo "‚úÖ <$tag> tags balanced ($OPEN pairs)"
          fi
        done
        
        if [ $EXIT_CODE -ne 0 ]; then
          echo ""
          echo "Fix the unbalanced tags above before deploying!"
          exit 1
        fi
        
        echo ""
        echo "‚úÖ HTML validation complete"
    
    # Step 5: Validate CSS
    - name: üé® Validate CSS Syntax
      run: |
        echo "=== Validating CSS ==="
        
        # Install modern CSS validator that supports CSS variables
        npm install stylelint stylelint-config-standard
        
        # Create stylelint config (supports modern CSS)
        cat > .stylelintrc.json << 'EOF'
        {
          "extends": "stylelint-config-standard",
          "rules": {
            "property-no-vendor-prefix": null,
            "no-descending-specificity": null,
            "selector-class-pattern": null,
            "custom-property-pattern": null,
            "alpha-value-notation": "number"
          }
        }
        EOF
        
        # Run validation
        echo "Running CSS validation..."
        if npx stylelint styles.css; then
          echo "‚úÖ CSS is valid"
        else
          echo "‚ö†Ô∏è CSS has some style warnings (not critical)"
        fi
        
        # Check for basic syntax issues
        echo ""
        echo "Checking CSS structure..."
        
        # Count braces
        OPEN_BRACES=$(grep -o "{" styles.css | wc -l)
        CLOSE_BRACES=$(grep -o "}" styles.css | wc -l)
        
        if [ $OPEN_BRACES -ne $CLOSE_BRACES ]; then
          echo "‚ùå ERROR: Unbalanced braces (open: $OPEN_BRACES, close: $CLOSE_BRACES)"
          exit 1
        else
          echo "‚úÖ CSS braces balanced ($OPEN_BRACES pairs)"
        fi
        
        # Check file size
        CSS_SIZE=$(wc -c < styles.css)
        CSS_KB=$(($CSS_SIZE / 1024))
        echo "üìè CSS file size: ${CSS_KB} KB"
        
        if [ $CSS_SIZE -gt 204800 ]; then
          echo "‚ö†Ô∏è Warning: CSS is larger than 200 KB"
        fi
        
        # Check for !important overuse
        IMPORTANT_COUNT=$(grep -c "!important" styles.css || true)
        if [ $IMPORTANT_COUNT -gt 15 ]; then
          echo "‚ö†Ô∏è Warning: Found $IMPORTANT_COUNT !important declarations (try to minimize)"
        else
          echo "‚úÖ !important usage is reasonable ($IMPORTANT_COUNT instances)"
        fi
        
        echo ""
        echo "‚úÖ CSS validation complete"
    
    # Step 6: Validate JavaScript with proper syntax checker
    - name: ‚öôÔ∏è Validate JavaScript Syntax
      run: |
        echo "=== Validating JavaScript ==="
        
        # Use Node.js to check syntax
        echo "Checking JavaScript syntax..."
        if node --check script.js 2>&1 | tee js_errors.log; then
          echo "‚úÖ JavaScript syntax is valid"
        else
          echo ""
          echo "‚ùå JAVASCRIPT SYNTAX ERROR!"
          echo ""
          cat js_errors.log
          echo ""
          echo "Common JavaScript errors:"
          echo "  1. Missing closing brackets/braces"
          echo "  2. Unclosed strings"
          echo "  3. Missing semicolons (sometimes)"
          echo "  4. Typos in keywords"
          exit 1
        fi
        
        # Check for dangerous code
        echo ""
        echo "Running security checks..."
        
        if grep -q "eval(" script.js; then
          echo "‚ùå ERROR: Found eval() - major security risk!"
          exit 1
        else
          echo "‚úÖ No eval() found"
        fi
        
        # Check for var usage
        VAR_COUNT=$(grep -c "var " script.js || true)
        if [ $VAR_COUNT -gt 0 ]; then
          echo "‚ö†Ô∏è Warning: Found $VAR_COUNT 'var' declarations (prefer let/const)"
        else
          echo "‚úÖ No 'var' usage (good practice)"
        fi
        
        # Count console.log
        CONSOLE_COUNT=$(grep -c "console.log" script.js || true)
        if [ $CONSOLE_COUNT -gt 15 ]; then
          echo "‚ö†Ô∏è Warning: Many console.log statements ($CONSOLE_COUNT) - consider removing for production"
        else
          echo "‚úÖ Console.log usage acceptable ($CONSOLE_COUNT)"
        fi
        
        # Check file size
        JS_SIZE=$(wc -c < script.js)
        JS_KB=$(($JS_SIZE / 1024))
        echo "üìè JavaScript file size: ${JS_KB} KB"
        
        if [ $JS_SIZE -gt 512000 ]; then
          echo "‚ùå ERROR: JavaScript exceeds 500 KB!"
          exit 1
        elif [ $JS_SIZE -gt 204800 ]; then
          echo "‚ö†Ô∏è Warning: JavaScript is larger than 200 KB"
        fi
        
        echo "‚úÖ JavaScript validation complete"
    
    # Step 7: Enhanced Security Scan
    - name: üîí Security Scan
      run: |
        echo "=== Security Scan ==="
        
        EXIT_CODE=0
        
        # Check for localhost
        echo "Checking for localhost URLs..."
        if grep -rn "localhost" index.html script.js 2>/dev/null; then
          echo ""
          echo "‚ùå ERROR: Found 'localhost' in code!"
          echo "These URLs won't work in production."
          echo "Replace with your production URL."
          EXIT_CODE=1
        else
          echo "‚úÖ No localhost URLs found"
        fi
        
        # Check for API keys
        echo ""
        echo "Checking for exposed API keys..."
        if grep -rinE "(api[_-]?key|apikey|api[_-]?secret)" index.html script.js 2>/dev/null; then
          echo ""
          echo "‚ùå ERROR: Possible API key found in code!"
          echo "Never commit API keys to GitHub!"
          EXIT_CODE=1
        else
          echo "‚úÖ No API keys detected"
        fi
        
        # Check for passwords
        echo ""
        echo "Checking for hardcoded passwords..."
        if grep -rinE "password.*[:=].*['\"]" index.html script.js 2>/dev/null; then
          echo ""
          echo "‚ùå ERROR: Possible password found in code!"
          EXIT_CODE=1
        else
          echo "‚úÖ No hardcoded passwords"
        fi
        
        # Check for TODO/FIXME
        echo ""
        echo "Checking for unfinished work..."
        TODO_COUNT=$(grep -ric "TODO\|FIXME" index.html styles.css script.js || true)
        if [ $TODO_COUNT -gt 0 ]; then
          echo "‚ÑπÔ∏è Info: Found $TODO_COUNT TODO/FIXME comments"
          grep -rn "TODO\|FIXME" index.html styles.css script.js || true
        else
          echo "‚úÖ No TODO/FIXME comments"
        fi
        
        if [ $EXIT_CODE -ne 0 ]; then
          echo ""
          echo "‚ùå Security issues found! Fix before deploying."
          exit 1
        fi
        
        echo ""
        echo "‚úÖ Security scan passed"
    
    # Step 8: Link Checker
    - name: üîó Check Internal Links
      run: |
        echo "=== Link Validation ==="
        
        # Extract all links
        grep -oP '(href|src)="[^"]*"' index.html | cut -d'"' -f2 > links.txt || true
        
        if [ ! -s links.txt ]; then
          echo "‚ÑπÔ∏è No links found"
          rm -f links.txt
          exit 0
        fi
        
        echo "Found $(wc -l < links.txt) links to check"
        
        BROKEN=0
        while IFS= read -r link; do
          # Skip external, anchors, mailto, tel
          if [[ $link =~ ^http ]] || [[ $link =~ ^# ]] || [[ $link =~ ^mailto ]] || [[ $link =~ ^tel ]]; then
            continue
          fi
          
          # Remove leading ./
          link=${link#./}
          
          if [ -f "$link" ]; then
            echo "‚úÖ $link"
          else
            echo "‚ùå BROKEN: $link"
            BROKEN=$((BROKEN + 1))
          fi
        done < links.txt
        
        rm -f links.txt
        
        if [ $BROKEN -gt 0 ]; then
          echo ""
          echo "‚ùå Found $BROKEN broken link(s)!"
          echo "Fix these broken references before deploying."
          exit 1
        fi
        
        echo "‚úÖ All internal links valid"
    
    # Step 9: Performance Check
    - name: üìä Performance Analysis
      run: |
        echo "=== Performance Analysis ==="
        
        # File sizes
        HTML_SIZE=$(wc -c < index.html)
        CSS_SIZE=$(wc -c < styles.css)
        JS_SIZE=$(wc -c < script.js)
        TOTAL=$((HTML_SIZE + CSS_SIZE + JS_SIZE))
        
        echo "üì¶ File Sizes:"
        printf "   HTML: %6d KB (%d bytes)\n" $(($HTML_SIZE / 1024)) $HTML_SIZE
        printf "   CSS:  %6d KB (%d bytes)\n" $(($CSS_SIZE / 1024)) $CSS_SIZE
        printf "   JS:   %6d KB (%d bytes)\n" $(($JS_SIZE / 1024)) $JS_SIZE
        printf "   Total: %6d KB\n" $(($TOTAL / 1024))
        
        if [ $TOTAL -gt 1048576 ]; then
          echo "‚ö†Ô∏è Warning: Total exceeds 1 MB"
        else
          echo "‚úÖ Total size is acceptable"
        fi
        
        # Line counts
        echo ""
        echo "üìù Lines of Code:"
        printf "   HTML: %6d lines\n" $(wc -l < index.html)
        printf "   CSS:  %6d lines\n" $(wc -l < styles.css)
        printf "   JS:   %6d lines\n" $(wc -l < script.js)
        
        echo "‚úÖ Performance analysis complete"
    
    # Step 10: Final Summary
    - name: ‚úÖ Validation Summary
      run: |
        echo ""
        echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
        echo "‚ïë  ‚úÖ ALL VALIDATIONS PASSED! üéâ           ‚ïë"
        echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
        echo ""
        echo "‚úÖ All files present"
        echo "‚úÖ HTML structure validated (W3C)"
        echo "‚úÖ CSS syntax validated"
        echo "‚úÖ JavaScript syntax validated"
        echo "‚úÖ Security scan passed"
        echo "‚úÖ Links validated"
        echo "‚úÖ Performance checked"
        echo ""
        echo "üöÄ Code is production-ready!"
        echo ""
        echo "üìã Commit: ${{ github.sha }}"
        echo "üë§ Author: ${{ github.actor }}"
        echo "üåø Branch: ${{ github.ref_name }}"
  
  deployment-ready:
    name: Deployment Ready
    runs-on: ubuntu-latest
    needs: quality-checks
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
    - name: üéâ Ready to Deploy
      run: |
        echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
        echo "‚ïë     üéâ DEPLOYMENT READY! üöÄ              ‚ïë"
        echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
        echo ""
        echo "‚úÖ All quality checks passed"
        echo "‚úÖ All validations successful"
        echo "‚úÖ Code is production-ready"
        echo ""
        echo "üåê Your site will deploy automatically"
        echo "‚è±Ô∏è  Estimated time: 1-2 minutes"
    
    - name: üìù Create Summary
      run: |
        echo "### üéâ Deployment Ready! üöÄ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "All quality gates passed successfully!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Validations Completed:**" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ File existence check" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ HTML validation (W3C)" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ CSS validation" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ JavaScript syntax check" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ Security scan" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ Link validation" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ Performance analysis" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Build Info:**" >> $GITHUB_STEP_SUMMARY
        echo "- Commit: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- Author: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "- Branch: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY