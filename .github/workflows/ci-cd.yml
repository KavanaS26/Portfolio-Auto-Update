name: Portfolio CI/CD - Simple & Reliable

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  quality-checks:
    name: Quality Checks
    runs-on: ubuntu-latest
    
    steps:
    # Step 1: Get code
    - name: üì• Checkout Code
      uses: actions/checkout@v3
    
    # Step 2: Check files exist
    - name: üìÅ Check Required Files
      run: |
        echo "=== Checking Files ==="
        EXIT_CODE=0
        
        if [ -f "index.html" ]; then
          echo "‚úÖ index.html exists"
        else
          echo "‚ùå index.html NOT FOUND"
          EXIT_CODE=1
        fi
        
        if [ -f "styles.css" ]; then
          echo "‚úÖ styles.css exists"
        else
          echo "‚ùå styles.css NOT FOUND"
          EXIT_CODE=1
        fi
        
        if [ -f "script.js" ]; then
          echo "‚úÖ script.js exists"
        else
          echo "‚ùå script.js NOT FOUND"
          EXIT_CODE=1
        fi
        
        if [ $EXIT_CODE -ne 0 ]; then
          exit 1
        fi
    
    # Step 3: Basic HTML checks
    - name: üîç HTML Quality Check
      run: |
        echo "=== HTML Checks ==="
        
        # Check for DOCTYPE
        if grep -q "<!DOCTYPE html>" index.html; then
          echo "‚úÖ DOCTYPE present"
        else
          echo "‚ö†Ô∏è Warning: Missing DOCTYPE"
        fi
        
        # Check for lang attribute
        if grep -q '<html lang=' index.html; then
          echo "‚úÖ HTML lang attribute present"
        else
          echo "‚ö†Ô∏è Warning: Missing lang attribute"
        fi
        
        # Check for basic required tags
        if grep -q "<head>" index.html && grep -q "<body>" index.html; then
          echo "‚úÖ Basic HTML structure present"
        else
          echo "‚ùå ERROR: Missing <head> or <body> tags"
          exit 1
        fi
        
        # Count opening and closing tags
        OPEN_DIVS=$(grep -o "<div" index.html | wc -l)
        CLOSE_DIVS=$(grep -o "</div>" index.html | wc -l)
        
        if [ $OPEN_DIVS -eq $CLOSE_DIVS ]; then
          echo "‚úÖ Div tags balanced ($OPEN_DIVS opening, $CLOSE_DIVS closing)"
        else
          echo "‚ö†Ô∏è Warning: Unbalanced div tags ($OPEN_DIVS opening, $CLOSE_DIVS closing)"
        fi
        
        echo "‚úÖ HTML checks complete"
    
    # Step 4: CSS checks
    - name: üé® CSS Quality Check
      run: |
        echo "=== CSS Checks ==="
        
        # Check file size
        CSS_SIZE=$(wc -c < styles.css)
        CSS_KB=$(($CSS_SIZE / 1024))
        echo "üìè CSS file size: ${CSS_KB} KB"
        
        if [ $CSS_SIZE -gt 204800 ]; then
          echo "‚ö†Ô∏è Warning: CSS is larger than 200 KB"
        fi
        
        # Check for !important overuse
        IMPORTANT_COUNT=$(grep -c "!important" styles.css || true)
        echo "üìä !important count: $IMPORTANT_COUNT"
        
        if [ $IMPORTANT_COUNT -gt 15 ]; then
          echo "‚ö†Ô∏è Warning: Many !important declarations ($IMPORTANT_COUNT)"
        fi
        
        # Check for basic syntax
        if grep -q "{" styles.css && grep -q "}" styles.css; then
          echo "‚úÖ Basic CSS syntax present"
        else
          echo "‚ùå ERROR: CSS appears to be empty or malformed"
          exit 1
        fi
        
        echo "‚úÖ CSS checks complete"
    
    # Step 5: JavaScript checks
    - name: ‚öôÔ∏è JavaScript Quality Check
      run: |
        echo "=== JavaScript Checks ==="
        
        # Check file size
        JS_SIZE=$(wc -c < script.js)
        JS_KB=$(($JS_SIZE / 1024))
        echo "üìè JavaScript file size: ${JS_KB} KB"
        
        if [ $JS_SIZE -gt 512000 ]; then
          echo "‚ùå ERROR: JavaScript exceeds 500 KB (${JS_KB} KB)"
          exit 1
        elif [ $JS_SIZE -gt 204800 ]; then
          echo "‚ö†Ô∏è Warning: JavaScript is larger than 200 KB"
        fi
        
        # Check for dangerous code
        if grep -q "eval(" script.js; then
          echo "‚ùå ERROR: Found eval() - security risk!"
          exit 1
        else
          echo "‚úÖ No eval() found"
        fi
        
        # Check for var usage (prefer let/const)
        VAR_COUNT=$(grep -c "var " script.js || true)
        if [ $VAR_COUNT -gt 0 ]; then
          echo "‚ÑπÔ∏è Info: Found $VAR_COUNT 'var' declarations (prefer let/const)"
        fi
        
        # Count console.log
        CONSOLE_COUNT=$(grep -c "console.log" script.js || true)
        echo "üìä console.log count: $CONSOLE_COUNT"
        
        if [ $CONSOLE_COUNT -gt 10 ]; then
          echo "‚ö†Ô∏è Warning: Many console.log statements ($CONSOLE_COUNT)"
        fi
        
        echo "‚úÖ JavaScript checks complete"
    
    # Step 6: Security scan
    - name: üîí Security Scan
      run: |
        echo "=== Security Scan ==="
        
        # Check for localhost
        if grep -r "localhost" index.html script.js 2>/dev/null; then
          echo "‚ùå ERROR: Found 'localhost' in code!"
          echo "Replace with production URL before deploying."
          exit 1
        else
          echo "‚úÖ No localhost URLs found"
        fi
        
        # Check for API keys
        if grep -riE "(api[_-]?key|apikey)" index.html script.js 2>/dev/null; then
          echo "‚ùå ERROR: Possible API key found!"
          exit 1
        else
          echo "‚úÖ No API keys detected"
        fi
        
        # Check for passwords
        if grep -riE "password.*[:=].*['\"]" index.html script.js 2>/dev/null; then
          echo "‚ùå ERROR: Possible password found!"
          exit 1
        else
          echo "‚úÖ No hardcoded passwords"
        fi
        
        # Check for inline styles (bad practice)
        INLINE_STYLES=$(grep -c 'style=' index.html || true)
        if [ $INLINE_STYLES -gt 5 ]; then
          echo "‚ÑπÔ∏è Info: Found $INLINE_STYLES inline styles (consider moving to CSS)"
        fi
        
        echo "‚úÖ Security scan complete"
    
    # Step 7: Link checker
    - name: üîó Check Internal Links
      run: |
        echo "=== Link Check ==="
        
        # Extract href and src attributes
        grep -oP '(href|src)="[^"]*"' index.html | cut -d'"' -f2 > links.txt || true
        
        if [ ! -s links.txt ]; then
          echo "‚ÑπÔ∏è No links found to check"
          rm -f links.txt
          exit 0
        fi
        
        echo "Found $(wc -l < links.txt) links/resources"
        
        # Check internal links
        BROKEN=0
        while IFS= read -r link; do
          # Skip external links, anchors, mailto, tel
          if [[ $link =~ ^http ]] || [[ $link =~ ^# ]] || [[ $link =~ ^mailto ]] || [[ $link =~ ^tel ]]; then
            continue
          fi
          
          # Remove leading ./
          link=${link#./}
          
          # Check if file exists
          if [ -f "$link" ]; then
            echo "‚úÖ $link"
          else
            echo "‚ùå BROKEN: $link"
            BROKEN=$((BROKEN + 1))
          fi
        done < links.txt
        
        rm -f links.txt
        
        if [ $BROKEN -gt 0 ]; then
          echo ""
          echo "‚ùå Found $BROKEN broken internal link(s)"
          exit 1
        fi
        
        echo "‚úÖ All internal links OK"
    
    # Step 8: Performance check
    - name: üìä Performance Check
      run: |
        echo "=== Performance Check ==="
        
        # Total size
        HTML_SIZE=$(wc -c < index.html)
        CSS_SIZE=$(wc -c < styles.css)
        JS_SIZE=$(wc -c < script.js)
        TOTAL=$((HTML_SIZE + CSS_SIZE + JS_SIZE))
        TOTAL_KB=$(($TOTAL / 1024))
        
        echo "üì¶ Total size: ${TOTAL_KB} KB"
        echo "   HTML: $(($HTML_SIZE / 1024)) KB"
        echo "   CSS: $(($CSS_SIZE / 1024)) KB"
        echo "   JS: $(($JS_SIZE / 1024)) KB"
        
        if [ $TOTAL -gt 1048576 ]; then
          echo "‚ö†Ô∏è Warning: Total size exceeds 1 MB"
        else
          echo "‚úÖ Total size is good"
        fi
        
        # Line counts
        echo ""
        echo "üìù Lines of code:"
        echo "   HTML: $(wc -l < index.html) lines"
        echo "   CSS: $(wc -l < styles.css) lines"
        echo "   JS: $(wc -l < script.js) lines"
        
        echo "‚úÖ Performance check complete"
    
    # Step 9: Final summary
    - name: ‚úÖ Success Summary
      run: |
        echo ""
        echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
        echo "‚ïë  ‚úÖ ALL QUALITY CHECKS PASSED! üéâ     ‚ïë"
        echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
        echo ""
        echo "‚úÖ All files present"
        echo "‚úÖ HTML structure valid"
        echo "‚úÖ CSS quality good"
        echo "‚úÖ JavaScript quality good"
        echo "‚úÖ No security issues"
        echo "‚úÖ Links working"
        echo "‚úÖ Performance acceptable"
        echo ""
        echo "üöÄ Ready for deployment!"
        echo ""
        echo "üìã Commit: ${{ github.sha }}"
        echo "üë§ Author: ${{ github.actor }}"
        echo "üåø Branch: ${{ github.ref_name }}"
  
  # Job 2: Deployment notification
  deployment-ready:
    name: Deployment Ready
    runs-on: ubuntu-latest
    needs: quality-checks
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: üéâ Deployment Ready
      run: |
        echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
        echo "‚ïë     üéâ READY TO DEPLOY! üöÄ               ‚ïë"
        echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
        echo ""
        echo "All quality checks passed!"
        echo "Netlify will deploy automatically."
        echo ""
        echo "‚è±Ô∏è  Estimated deployment time: 1-2 minutes"
        echo "üåê Your site will be live soon!"
    
    - name: üìù Create Summary
      run: |
        echo "### üéâ Deployment Ready! üöÄ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "‚úÖ All quality checks passed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Checks completed:**" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ Files validated" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ HTML quality checked" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ CSS quality checked" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ JavaScript quality checked" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ Security scan passed" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ Links validated" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ Performance analyzed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Next:** Netlify automatic deployment" >> $GITHUB_STEP_SUMMARY